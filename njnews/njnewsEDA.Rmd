---
title: "NJ News Network and NJ Databook Merger"
author: "Matthew Bone"
date: "3/9/2021"
output: 
  html_document:
    fig_height: 6
    fig_width: 8
  pdf_document:
    fig_height: 3
    fig_width: 5
  word_document:
    fig_height: 3
    fig_width: 5
---

```{r, setup, include=FALSE}
library(mosaic)
library(readr)
library(tidyverse)
library(ggformula)
library(stringr)
library(data.table)
library(DT)
library(corrplot)
set.seed(1)

knitr::opts_chunk$set(
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
```

This document is an exploratory data analysis for the New Jersey News Network data. From the 12706-gephi.gexf.xml file, I derived a node and edge list using the software Gephi. Using Gephi, I was able to calculate a number of useful network metrics and export them in csv format. For the node dataset this includes metrics such as in/outdegree, eccentricity, authority, etc. For the edge dataset this includes the weight and direction. 

I also compiled a dataset from the [NJ Local News Search](https://newsecosystems.org/njsearch/) of all the websites and their municipalities. I used this to map each node, which represents a news source, to a specific municipality. 

In addition to these datasets, I used census and voting datasets from the [New Jersey Data Book](https://search.njdatabook.rutgers.edu/login.jsp). I was able to merge these to the nodes dataset by using the municipality name and county. The New Jersey Data Book has a wide array of data spanning educational, political, economic, and demographic metrics. It should be easy to merge any of this data to the node dataset.

```{r, include=FALSE}
nodes <- read_csv('njnodes.csv') %>%
  mutate()

url_end <- function(x) {
  str_extract(x, '\\.[a-zA-Z]*$')
}

url_ends <- paste(unique(unlist(lapply(nodes['label'], url_end))), collapse = "|")

edges <- read_csv('njedges.csv')

local <- read_csv('localnews.csv') %>%
  mutate(website = gsub('https://', '', website),
         website = gsub('http://','', website),
         website = gsub('www.', '', website),
         website = gsub('/.*$', '', website))

muni_key <- read_csv('local_to_data.csv')

census <- read_csv('census2019.csv')
voting <- read_csv('voting2019.csv')
budget <- read_csv('budget2019.csv')
```

```{r, include=FALSE}
muni_dict <- unlist(muni_key['data_muni'])
names(muni_dict) <- unlist(muni_key['local_muni'])

county_dict <- unlist(muni_key['county'])
names(county_dict) <- unlist(muni_key['data_muni'])

match_muni <- function(x) {
  muni_dict[x]
}

match_county <- function(x) {
  county_dict[x]
}

match_muni <- Vectorize(match_muni)
match_county <- Vectorize(match_county)

cmb_data <- local %>%
  mutate(label = website,
         municipal = match_muni(municipal),
         county = match_county(municipal)) %>%
  left_join(nodes, by='label') %>%
  left_join(census, by=c('municipal','county')) %>%
  left_join(voting, by=c('municipal','county')) %>%
  left_join(budget, by=c('municipal','county'))
```

### Sample of Nodes Dataset

There are more columns such as xy-coordinates, weighted degrees, and rgb-color values but I filtered some out to not overcrowd.

```{r, echo=FALSE}
nodes %>%
  sample(100) %>%
  select(id, label, size, degree, indegree, outdegree, eccentricity, authority, hub) %>%
  datatable(rownames = F)
```

### Sample of Edges Dataset

```{r, echo=FALSE}
edges %>%
  sample(100) %>%
  select(id, source, target, type, weight) %>%
  datatable(rownames = F)
```

### Sample of Combined Dataset

This combined dataset will allow us to measure network metrics of individual nodes against a wide array of municipality info from the New Jersey Data Book. There are many more columns in this dataset but I've only selected a few to not overcrowd.

```{r, echo=FALSE}
cmb_data %>%
  sample(100) %>%
  select(name, municipal, county, degree, population, perc_hispanic, democrats_perc, republicans_perc) %>%
  datatable(rownames = F)
```

### Correlation Matrix (Municipality-Level)

This matrix includes a select group of network metrics and NJ Databooks metrics that provide some interesting starting points for understanding how network effects may interact with municipal characteristics. The network metrics are the mean of all the outlets in a given municipality. 

```{r, include=FALSE, warning=FALSE}
corr_matrix <- cmb_data %>%
  group_by(municipal, county) %>%
  mutate(registered_perc = as.double(registered_perc),
         democrats_perc = as.double(democrats_perc),
         republicans_perc = as.double(republicans_perc),
         muni_budget_pc = as.double(muni_budget_pc),
         muni_budget = as.double(muni_budget)) %>%
  summarize(oulet_count = as.double(n()),
            weighted_indegree = mean(weighted_indegree, na.rm = T),
            weighted_outdegree = mean(weighted_outdegree, na.rm = T),
            eccentricity = mean(eccentricity, na.rm = T),
            authority = mean(authority, na.rm = T),
            hub = mean(hub, na.rm = T),
            population,
            perc_asian,
            perc_black,
            perc_hispanic,
            registered_perc,
            democrats_perc,
            republicans_perc,
            voter_turnout,
            muni_budget_pc,
            muni_budget) %>%
  ungroup() %>%
  unique() %>%
  select(-c(municipal, county)) %>%
  cor(use="complete.obs")
```

```{r, echo=FALSE}
corr_matrix %>%
  corrplot(tl.col = 'black', tl.srt = 60)
```






